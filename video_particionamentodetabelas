--Vídeo#1
--Setup - Criar o banco de dados venda
USE [vendas]
GO
CREATE TABLE [dbo].[venda](
	[cdvenda] [bigint] IDENTITY(1,1) NOT NULL,
	[dtvenda] [datetime] NOT NULL,
	[cdcliente] [bigint] NOT NULL,
 CONSTRAINT [PK_venda] PRIMARY KEY CLUSTERED 
(
	[cdvenda] ASC
)on [PRIMARY]
) ON [PRIMARY]
GO

USE [master]
go
DROP INDEX [Ix_Venda] ON vendas.[dbo].[venda]
GO

--Lab 
use vendas	   
GO
sp_help venda

--Adicona a coluna para particionar a tabela
alter table venda add  nrano int default (9) not null
go
update venda set nrano = year(dtvenda) where nrano = 9
GO
alter table venda drop constraint pk_venda
GO
alter table venda add constraint PK_Venda primary key (cdvenda, nrano)
GO



 -- Alteração do Banco de Dados
 -- Criar os Filegroups
 select distinct(nrano) from venda
--2013
--2016
--2014
--2012
--2015
use master
go
alter database vendas add filegroup FG2012;
go
alter database vendas add filegroup FG2013;
go
alter database vendas add filegroup FG2014;
GO
alter database vendas add filegroup FG2015;
go
alter database vendas add filegroup FG2016;

--
-- Adicionando os Arquivos
--
alter database vendas add file (name = 'vd2012', filename = 'E:\SQLData\vd2012.ndf') to filegroup fg2012
GO
alter database vendas add file (name = 'vd2013', filename = 'E:\SQLData\vd2013.ndf') to filegroup fg2013
GO
alter database vendas add file (name = 'vd2014', filename = 'E:\SQLData\vd2014.ndf') to filegroup fg2014
GO
alter database vendas add file (name = 'vd2015', filename = 'E:\SQLData\vd2015.ndf') to filegroup fg2015
GO
alter database vendas add file (name = 'vd2016', filename = 'E:\SQLData\vd2016.ndf') to filegroup fg2016
GO

--
-- Criando a Função
--
use vendas
go
Create partition function PF_Vendas(int) as
	range left for values (2013, 2014, 2015, 2016)

-- LEFT é parametro do Range que coloca todos os novos registros a esquerda 
-- FG2013 <= 2013
-- FG2014 =  2014
-- FG2015 = 2015
-- FG2016 = 2016

--
-- Criando Schema
--
use vendas
go
Create partition scheme SH_Vendas as
Partition PF_Vendas to ( FG2012,FG2013, FG2014, FG2015, FG2016);


USE [vendas]
GO
ALTER TABLE [dbo].[venda] DROP CONSTRAINT [PK_venda]
GO
ALTER TABLE [dbo].[venda] ADD  CONSTRAINT [PK_venda] PRIMARY KEY CLUSTERED 
(
	[cdvenda] ASC,
	[nrano] ASC
)ON sh_vendas (nrano)
GO

	insert into venda values('20160101', 1, 2016)


--Vídeo 2: material/video2_particionamentodetabelas 
